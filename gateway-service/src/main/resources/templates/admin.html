<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>고객 관리 - The MSA Cafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="/css/style.css" rel="stylesheet">
    <script src="/js/common.js"></script>

    <style>
        /* 테이블 컬럼 너비 조정 */
        .col-id { width: 10%; }
        .col-name { width: 20%; }
        .col-email { width: 30%; }
        .col-role { width: 15%; }
        .col-action { width: 25%; }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbarFragment}"></div>

<div class="container">
    <div class="content-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="page-title mb-0">
                <i class="bi bi-people-fill"></i> 고객 관리
            </h3>
            <div>
                <button class="btn btn-outline-secondary btn-sm me-2" onclick="loadUsers()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="userTable">
                <thead class="table-light">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-name">사용자명</th>
                    <th class="col-email">이메일</th>
                    <th class="col-role">역할</th>
                    <th class="col-action">관리</th>
                </tr>
                </thead>
                <tbody id="userTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 사용자 정보 수정</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">사용자명</label>
                        <input type="text" class="form-control" id="editUsername" readonly>
                        <div class="form-text">사용자명은 변경할 수 없습니다.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="editEmail">
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">역할</label>
                        <select class="form-select" id="editRole">
                            <option value="USER">일반 사용자 (USER)</option>
                            <option value="ADMIN">관리자 (ADMIN)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-coffee" onclick="updateUser()">수정 완료</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers();
    });

    // 사용자 목록 로드
    async function loadUsers() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('로그인이 필요합니다.');
            location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const users = await response.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const tr = document.createElement('tr');

                    // 역할에 따른 뱃지 스타일
                    let roleBadge = user.role === 'ADMIN'
                        ? '<span class="badge bg-danger">ADMIN</span>'
                        : '<span class="badge bg-success">USER</span>';

                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td class="fw-bold">${user.username}</td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm me-1"
                                onclick="showEditModal(${user.id}, '${user.username}', '${user.email}', '${user.role}')">
                                <i class="bi bi-pencil"></i> 수정
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${user.id})">
                                <i class="bi bi-trash"></i> 삭제
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                console.error('Failed to load users');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    let editModalInstance;

    // 수정 모달 열기
    function showEditModal(id, username, email, role) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;

        const modalEl = document.getElementById('editModal');
        editModalInstance = new bootstrap.Modal(modalEl);
        editModalInstance.show();
    }

    // 사용자 정보 수정
    async function updateUser() {
        const id = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value;
        const email = document.getElementById('editEmail').value;
        const role = document.getElementById('editRole').value;
        const token = localStorage.getItem('token');

        try {
            const response = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ username, email, role })
            });

            if (response.ok) {
                alert('회원 정보가 수정되었습니다.');
                editModalInstance.hide();
                loadUsers();
            } else {
                alert('수정에 실패했습니다.');
            }
        } catch (error) {
            console.error(error);
            alert('오류가 발생했습니다.');
        }
    }

    // 사용자 삭제
    async function deleteUser(userId) {
        if (!confirm('정말로 이 사용자를 삭제하시겠습니까?')) return;

        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                loadUsers();
            } else {
                alert('삭제 실패');
            }
        } catch (error) {
            console.error(error);
        }
    }
</script>

</body>
</html>